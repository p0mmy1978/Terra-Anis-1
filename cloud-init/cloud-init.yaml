#cloud-config
package_update: true
package_upgrade: true

packages:
  - software-properties-common
  - python3-pip
  - git
  - jq

runcmd:
  # Install Ansible
  - add-apt-repository --yes --update ppa:ansible/ansible
  - apt install -y ansible
  
  # Generate SSH key for Ansible
  - sudo -u azure_user ssh-keygen -t rsa -b 4096 -f /home/azure_user/.ssh/id_rsa -N '' -C 'ansible@azure'
  - sudo -u azure_user chmod 600 /home/azure_user/.ssh/id_rsa
  - sudo -u azure_user chmod 644 /home/azure_user/.ssh/id_rsa.pub
  
  # Install Azure CLI
  - curl -sL https://aka.ms/InstallAzureCLIDeb | bash
  
  # Wait for managed identity to be ready (sometimes takes a moment)
  - sleep 30
  
  # Login with managed identity
  - az login --identity
  
  # Upload public key to Key Vault
  - |
    PUBKEY=$(cat /home/azure_user/.ssh/id_rsa.pub)
    az keyvault secret set \
      --vault-name "${key_vault_name}" \
      --name "ansible-public-key" \
      --value "$PUBKEY" \
      --output none
  
  # Create ansible directory
  - sudo -u azure_user mkdir -p /home/azure_user/ansible
  
  # Log completion
  - echo "Ansible installation and Key Vault upload completed at $(date)" > /var/log/cloud-init-complete.log

write_files:
  - path: /etc/profile.d/keyvault-info.sh
    content: |
      echo "Key Vault Name: ${key_vault_name}"
      echo "Ansible public key stored in Key Vault secret: ansible-public-key"
